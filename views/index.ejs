<%- include('partials/header', { title: 'Dashboard - Admin Toko' }) %>

    <!-- Dashboard Stats Row -->
    <% 
        let totalIncome = 0;
        let totalTransactions = purchases.length;
        let lowStockCount = products.filter(p => p.quantity < 10).length;
        purchases.forEach(p => { if(p.status === 'completed') totalIncome += parseFloat(p.total_price); });
    %>
    <div class="row">
        <div class="col s12 m4">
            <div class="card-panel stat-card card-hover">
                <div class="stat-icon bg-blue-light"><i class="material-icons">payments</i></div>
                <div class="stat-info">
                    <h6>Total Pendapatan</h6>
                    <h4>Rp <%= totalIncome.toLocaleString('id-ID') %></h4>
                </div>
            </div>
        </div>
        <div class="col s12 m4">
            <div class="card-panel stat-card card-hover">
                <div class="stat-icon bg-green-light"><i class="material-icons">shopping_bag</i></div>
                <div class="stat-info">
                    <h6>Total Transaksi</h6>
                    <h4><%= totalTransactions %></h4>
                </div>
            </div>
        </div>
        <div class="col s12 m4">
            <div class="card-panel stat-card card-hover">
                <div class="stat-icon bg-orange-light"><i class="material-icons">inventory_2</i></div>
                <div class="stat-info">
                    <h6>Stok Menipis</h6>
                    <h4 class="<%= lowStockCount > 0 ? 'red-text' : '' %>"><%= lowStockCount %> Item</h4>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- KOLOM KIRI: Form & Stok -->
        <div class="col s12 l4">
            <!-- Card Input -->
            <div class="card-panel">
                <h5 class="section-title"><i class="material-icons">add_circle</i>Transaksi Baru</h5>
                <form action="/buy" method="POST" style="margin-top: 25px;">
                    <div class="input-field">
                        <select name="product_id" required>
                            <option value="" disabled selected>Pilih Produk...</option>
                            <% products.forEach(product => { %>
                                <option value="<%= product.id %>">
                                    <%= product.name %> (Stok: <%= product.quantity %>)
                                </option>
                            <% }) %>
                        </select>
                        <label>Produk</label>
                    </div>

                    <div class="input-field">
                        <input id="quantity" name="quantity" type="number" min="1" required>
                        <label for="quantity">Jumlah Qty</label>
                    </div>

                    <button class="btn btn-primary waves-effect waves-light" type="submit">
                        Proses Transaksi <i class="material-icons right">arrow_forward</i>
                    </button>
                </form>
            </div>

            <!-- Card Stok Mini -->
            <div class="card-panel" style="max-height: 400px; overflow-y: auto;">
                <h5 class="section-title" style="font-size: 1rem;"><i class="material-icons">list</i>Monitor Stok</h5>
                <table class="centered">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Sisa</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% products.forEach(product => { %>
                            <tr>
                                <td class="left-align" style="font-weight: 500;"><%= product.name %></td>
                                <td>
                                    <span class="stock-badge <%= product.quantity < 10 ? 'stock-low' : 'stock-ok' %>">
                                        <%= product.quantity %>
                                    </span>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- KOLOM KANAN: Riwayat Table -->
        <div class="col s12 l8">
            <div class="card-panel">
                <h5 class="section-title"><i class="material-icons">history</i>Riwayat Transaksi</h5>
                
                <% if (purchases.length === 0) { %>
                    <div class="center-align grey-text" style="padding: 40px;">
                        <i class="material-icons" style="font-size: 4rem; opacity: 0.2;">receipt_long</i>
                        <p>Belum ada data transaksi.</p>
                    </div>
                <% } else { %>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produk</th>
                                    <th class="center-align">Qty</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Waktu</th>
                                    <th class="center-align">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% purchases.forEach(pur => { %>
                                    <tr>
                                        <td style="font-weight: 600; color: var(--text-main);"><%= pur.name %></td>
                                        <td class="center-align"><%= pur.quantity %></td>
                                        <td style="font-weight: 600; color: var(--primary-color);">
                                            Rp <%= pur.total_price.toLocaleString('id-ID') %>
                                        </td>
                                        <td>
                                            <span class="status-badge <%= pur.status === 'completed' ? 'status-completed' : 'status-cancelled' %>">
                                                <%= pur.status === 'completed' ? 'Sukses' : 'Batal' %>
                                            </span>
                                        </td>
                                        <td class="grey-text" style="font-size: 0.85rem;">
                                            <%= new Date(pur.created_at).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}) %>
                                        </td>
                                        <td class="center-align">
                                            <% if(pur.status === 'completed') { %>
                                                <form action="/cancel/<%= pur.id %>" method="POST" onsubmit="return confirm('Batalkan transaksi ini? Stok akan dikembalikan.')">
                                                    <button type="submit" class="btn-floating btn-small waves-effect waves-light white z-depth-1 tooltipped" data-position="left" data-tooltip="Batalkan">
                                                        <i class="material-icons red-text">close</i>
                                                    </button>
                                                </form>
                                            <% } else { %>
                                                <i class="material-icons grey-text lighten-3" style="font-size: 1.2rem;">block</i>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

<%- include('partials/footer') %>